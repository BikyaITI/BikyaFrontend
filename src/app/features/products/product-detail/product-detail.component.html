<!-- erorr Message  -->
<div
  class="alert alert-danger alert-dismissible fade show"
  role="alert"
  *ngIf="errorMessage"
>
  <i class="bi bi-check-circle me-2"></i>
  {{ errorMessage }}
  <button
    type="button"
    class="btn-close"
    data-bs-dismiss="alert"
    aria-label="Close"
  ></button>
</div>

<!-- Success Message -->
<div
  class="alert alert-success alert-dismissible fade show"
  role="alert"
  *ngIf="successMessage"
>
  <i class="bi bi-check-circle me-2"></i>
  {{ successMessage }}
  <button
    type="button"
    class="btn-close"
    data-bs-dismiss="alert"
    aria-label="Close"
  ></button>
</div>

<div class="container mt-4" *ngIf="product">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a routerLink="/">Home</a></li>
      <li class="breadcrumb-item"><a routerLink="/products">Products</a></li>
      <li class="breadcrumb-item active">{{ product.title }}</li>
    </ol>
  </nav>

  <div class="row">
    <!-- Product Images -->
    <div class="col-lg-6">
      <div class="product-gallery">
        <div class="main-image mb-3 position-relative">
          <img
            [src]="selectedImage ? GetImageUrl(selectedImage) : '/product.png'"
            [alt]="product.title"
            class="img-fluid rounded shadow-sm w-100"
            style="height: 400px; object-fit: cover"
            (error)="onImageError($event)"
          />
          <div class="dropdown position-absolute top-0 end-0 m-1">
            <button
              class="btn btn-md btn-outline-dark"
              [hidden]="getRole() !== 'owner'"
              data-bs-toggle="dropdown"
              aria-expanded="false"
            >
              <i class="bi bi-gear-fill"></i>
            </button>

            <ul class="dropdown-menu dropdown-menu-end">
              <li>
                <a
                  class="dropdown-item d-flex align-items-center gap-2 add"
                  (click)="addImage()"
                >
                  <i class="bi bi-plus-circle"></i> Add Image
                </a>
              </li>
              <li>
                <a
                  class="dropdown-item d-flex align-items-center gap-2 delete"
                  (click)="deleteImage(selectedImage!)"
                >
                  <i class="bi bi-trash-fill text-danger"></i> Delete Image
                </a>
              </li>
              <li>
                <a
                  class="dropdown-item d-flex align-items-center gap-2 main"
                  (click)="setAsMain(selectedImage!)"
                >
                  <i class="bi bi-star-fill text-warning"></i> Set as Main
                </a>
              </li>
            </ul>
          </div>
        </div>

        <div
          class="thumbnail-images"
          *ngIf="product.images && product.images.length > 1"
        >
          <div class="row g-2">
            <div class="col-3" *ngFor="let image of product.images">
              <img
                [src]="GetImageUrl(image)"
                [alt]="product.title"
                class="img-fluid rounded cursor-pointer thumbnail"
                [class.active]="selectedImage?.id === image.id"
                [class.main]="image.isMain"
                (click)="selectImage(image)"
                (error)="onImageError($event)"
                style="height: 80px; width: 100px; object-fit: cover"
              />
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Product Info -->
    <div class="col-lg-6">
      <div class="product-info">
        <div class="d-flex justify-content-between align-items-start mb-3">
          <h1 class="h2 mb-0">{{ product.title }}</h1>
          <div class="badges">
            <span class="badge bg-success me-2" *ngIf="product.isForExchange">
              <i class="bi bi-arrow-left-right"></i> Exchange Available
            </span>
          </div>
        </div>

        <div class="price-section mb-4">
          <h3 class="text-primary mb-0">
            {{ product.price | number : "1." }} EGP
          </h3>
        </div>

        <div class="seller-info mb-4">
          <div class="d-flex align-items-center">
            <div class="avatar me-3">
              <div
                class="bg-primary rounded-circle d-flex align-items-center justify-content-center"
                style="width: 50px; height: 50px"
              >
                <i class="bi bi-person-fill text-white fs-4"></i>
              </div>
            </div>
            <div>
              <a class="mb-0 d-block" routerLink="#">{{
                product.userName || "Unknown Seller"
              }}</a>
              <small class="text-muted">
                <i class="bi bi-calendar3"></i>
                Listed {{ product.createdAt | date : "mediumDate" }}
              </small>
            </div>
          </div>
        </div>

        <div class="description mb-4">
          <h5>Description</h5>
          <p class="text-muted">{{ product.description }}</p>
        </div>

        <div class="product-details mb-4">
          <h5>Details</h5>
          <div class="row">
            <div class="col-6">
              <strong>Category:</strong>
              <span class="badge bg-light text-dark ms-2">{{
                product.categoryName
              }}</span>
            </div>
            <div class="col-6">
              <strong>Condition:</strong>
              <span
                class="ms-2 badge"
                [class]="getConditionBadgeClass(product.condition)"
                >{{ product.condition }}</span
              >
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons" *ngIf="currentUser && getRole() === 'user'">
          <div class="row g-2">
            <div class="col-md-6">
              <button
                class="btn btn-primary btn-lg w-100"
                [routerLink]="['/checkout']"
                [queryParams]="{ productId: product.id }"
              >
                <i class="bi bi-cart-plus"></i> Buy Now
              </button>
            </div>
            <div class="col-md-6">
              <button
                class="btn btn-outline-primary btn-lg w-100"
                [disabled]="!product.isForExchange"
                (click)="onExchangeClick()"
              >
                <i class="bi bi-arrow-left-right"></i> Propose Exchange
              </button>
            </div>
          </div>

          <div class="row g-2 mt-2">
            <div class="col-md-6">
              <button
                class="btn btn-outline-danger w-100 mb-3"
                [class.active]="product.isInWishlist"
                [disabled]="!currentUser"
                title="add to wishlist"
                (click)="ToggleWishlist(product)"
              >
                <i class="bi bi-heart"></i> Add to Wishlist
              </button>
            </div>
            <div class="col-md-6"></div>
          </div>
        </div>

        <!-- Owner Actions -->

        <div class="owner-actions" *ngIf="currentUser && getRole() === 'owner'">
          <div class="row g-2">
            <div class="col-6">
              <button
                class="btn btn-warning w-100"
                [routerLink]="['/edit-product', product.id]"
              >
                <i class="bi bi-pencil"></i> Edit
              </button>
            </div>
            <div class="col-6">
              <button class="btn btn-danger w-100" (click)="deleteProduct()">
                <i class="bi bi-trash"></i> Delete
              </button>
            </div>
          </div>
        </div>

        <!-- admin Actions -->

        <div class="admin-actions" *ngIf="currentUser && getRole() === 'admin'">
          <div class="row g-2">
            <div class="col-6">
              <button
                class="btn btn-success w-100"
                (click)="approveProduct()"
                [disabled]="product.isApproved"
              >
                <i class="fas fa-check"></i> Approve
              </button>
            </div>
            <div class="col-6">
              <button class="btn btn-danger w-100" (click)="deleteProduct()">
                <i class="bi bi-trash"></i> Reject
              </button>
            </div>
          </div>
        </div>

        <!-- Login Prompt -->
        <div class="login-prompt" *ngIf="!currentUser">
          <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle"></i>
            <a routerLink="/login" class="alert-link">Login</a> to purchase or
            exchange this item
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Related Products -->

  <div class="related-products mt-5" *ngIf="showRelatedProducts()">
    <h3 class="mb-4">Related Products</h3>
    <div class="row">
      <div
        class="col-lg-3 col-md-6 mb-4"
        *ngFor="let product of relatedProducts"
      >
        <app-product-list
          [product]="product"
          [role]="'user'"
        ></app-product-list>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div class="container mt-5" *ngIf="isLoading">
    <div class="text-center">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-3">Loading product details...</p>
    </div>
  </div>

  <!-- Error State -->
  <div class="container mt-5" *ngIf="!isLoading && !product">
    <div class="text-center">
      <i
        class="fas fa-exclamation-triangle text-warning"
        style="font-size: 3rem"
      ></i>
      <h3 class="mt-3">Product Not Found</h3>
      <p class="text-muted" *ngIf="errorMessage">{{ errorMessage }}</p>
      <p class="text-muted" *ngIf="!errorMessage">
        The product you're looking for doesn't exist or has been removed.
      </p>
      <a routerLink="/products" class="btn btn-primary">Back to Products</a>
    </div>
  </div>

  <!-- Loading State -->
  <div class="container mt-5" *ngIf="isLoading">
    <div class="loading-spinner">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div class="modal fade" id="Modal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">{{ confirmTitle }}</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
          ></button>
        </div>
        <div class="modal-body">
          <p>
            {{ confirmMessage }} "<strong>{{ product.title }}</strong
            >"?
          </p>
          <p class="text-muted">This action cannot be undone.</p>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Cancel
          </button>
          <button
            type="button"
            class="btn"
            [class.btn-danger]="confirmType === 'delete'"
            [class.btn-success]="confirmType === 'approve'"
            (click)="confirmAction()"
            [disabled]="doAction"
          >
            <span
              *ngIf="doAction"
              class="spinner-border spinner-border-sm me-2"
            ></span>
            {{ doAction ? confirmbuttonLoading : confirmButtonText }}
          </button>
        </div>
      </div>
    </div>
  </div>
  <!-- Add Image Modal -->
  <div class="modal fade" id="addImageModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <form (ngSubmit)="submitNewImage()" #imageForm="ngForm">
          <div class="modal-header">
            <h5 class="modal-title">Add New Image</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="imageFile" class="form-label">Select Image</label>
              <input
                type="file"
                class="form-control"
                id="imageFile"
                (change)="onFileSelected($event)"
                required
              />
            </div>
            <div class="form-check">
              <input
                type="checkbox"
                class="form-check-input"
                id="setAsMain"
                [(ngModel)]="newImageIsMain"
                name="isMain"
              />
              <label class="form-check-label" for="setAsMain"
                >Set as Main</label
              >
              <div class="text-danger mt-1" *ngIf="imageErrorMessage">
                <i class="bi bi-exclamation-triangle-fill"></i>
                {{ imageErrorMessage }}
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button
              type="submit"
              class="btn btn-primary"
              [disabled]="!selectedFile"
            >
              Upload
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
