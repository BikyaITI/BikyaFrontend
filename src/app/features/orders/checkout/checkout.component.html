<div class="container mt-4">
  <h2><i class="bi bi-cart-check"></i> Checkout</h2>
  <p class="text-muted">
    Enter your shipping details to proceed with the order
  </p>
  <div *ngIf="!isSwapOrder" class="alert alert-info" role="alert">
    <i class="bi bi-info-circle me-2"></i>
    <strong>Shipping Fee:</strong> A fixed shipping fee of
    {{ REGULAR_SHIPPING_FEE | currency : "EGP" : "symbol" : "1.2-2" }} will be
    added to your order.
  </div>
  <div *ngIf="isSwapOrder" class="alert alert-warning" role="alert">
    <i class="bi bi-arrow-repeat me-2"></i>
    <strong>Exchange Order:</strong> This is an exchange order. Only shipping
    fee of {{ SWAP_SHIPPING_FEE | currency : "EGP" : "symbol" : "1.2-2" }} will
    be charged.
  </div>

  <!-- Error Message -->
  <div *ngIf="errorMessage" class="alert alert-danger" role="alert">
    {{ errorMessage }}
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-spinner text-center">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <!-- Checkout Form -->
  <div *ngIf="!isLoading && product && product.id" class="row">
    <div class="col-md-8">
      <form #checkoutForm="ngForm" (ngSubmit)="onSubmit()">
        <div class="card shadow-sm p-4">
          <h5>Shipping Information</h5>
          <div class="mb-3">
            <label for="recipientName" class="form-label">Recipient Name</label>
            <input
              type="text"
              class="form-control"
              id="recipientName"
              name="recipientName"
              [(ngModel)]="shippingInfo.recipientName"
              required
              #recipientName="ngModel"
              [class.is-invalid]="
                recipientName.invalid && recipientName.touched
              "
            />
            <div
              *ngIf="recipientName.invalid && recipientName.touched"
              class="invalid-feedback"
            >
              Recipient Name is required
            </div>
          </div>
          <div class="mb-3">
            <label for="address" class="form-label">Address</label>
            <input
              type="text"
              class="form-control"
              id="address"
              name="address"
              [(ngModel)]="shippingInfo.address"
              required
              #address="ngModel"
              [class.is-invalid]="address.invalid && address.touched"
            />
            <div
              *ngIf="address.invalid && address.touched"
              class="invalid-feedback"
            >
              Address is required
            </div>
          </div>
          <div class="mb-3">
            <label for="city" class="form-label">City</label>
            <input
              type="text"
              class="form-control"
              id="city"
              name="city"
              [(ngModel)]="shippingInfo.city"
              required
              #city="ngModel"
              [class.is-invalid]="city.invalid && city.touched"
            />
            <div *ngIf="city.invalid && city.touched" class="invalid-feedback">
              City is required
            </div>
          </div>
          <div class="mb-3">
            <label for="postalCode" class="form-label">Postal Code</label>
            <input
              type="text"
              class="form-control"
              id="postalCode"
              name="postalCode"
              [(ngModel)]="shippingInfo.postalCode"
              required
              #postalCode="ngModel"
              [class.is-invalid]="postalCode.invalid && postalCode.touched"
            />
            <div
              *ngIf="postalCode.invalid && postalCode.touched"
              class="invalid-feedback"
            >
              Postal Code is required
            </div>
          </div>
          <div class="mb-3">
            <label for="phoneNumber" class="form-label">Phone Number</label>
            <input
              type="text"
              class="form-control"
              id="phoneNumber"
              name="phoneNumber"
              [(ngModel)]="shippingInfo.phoneNumber"
              required
              #phoneNumber="ngModel"
              [class.is-invalid]="phoneNumber.invalid && phoneNumber.touched"
            />
            <div
              *ngIf="phoneNumber.invalid && phoneNumber.touched"
              class="invalid-feedback"
            >
              Phone Number is required
            </div>
          </div>
          <div class="mb-3">
            <label for="quantity" class="form-label">Quantity</label>
            <input
              type="number"
              class="form-control"
              id="quantity"
              name="quantity"
              [(ngModel)]="orderRequest.quantity"
              min="1"
              required
              #quantity="ngModel"
              [class.is-invalid]="quantity.invalid && quantity.touched"
              (ngModelChange)="calculateTotal()"
            />
            <div
              *ngIf="quantity.invalid && quantity.touched"
              class="invalid-feedback"
            >
              Quantity must be at least 1
            </div>
            <small class="text-muted" *ngIf="!isSwapOrder">
              Price per item:
              {{ product.price | currency : "EGP" : "symbol" : "1.2-2" }}
            </small>
          </div>
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h5 class="text-primary mb-0">
                Total: {{ totalAmount | currency : "EGP" : "symbol" : "1.2-2" }}
              </h5>
              <small class="text-muted" *ngIf="!isSwapOrder">
                Includes
                {{
                  REGULAR_SHIPPING_FEE | currency : "EGP" : "symbol" : "1.2-2"
                }}
                shipping fee
              </small>
              <small class="text-muted" *ngIf="isSwapOrder">
                Exchange order - shipping fee only
              </small>
            </div>
            <button
              type="submit"
              class="btn btn-primary"
              [disabled]="checkoutForm.invalid || isLoading"
              [attr.aria-disabled]="isLoading ? true : null"
            >
              <i class="bi bi-credit-card"></i> Proceed to Payment
            </button>
          </div>
        </div>
      </form>
    </div>

    <div class="col-md-4">
      <div class="card shadow-sm p-4">
        <h5>Order Summary</h5>
        <div *ngIf="product" class="d-flex align-items-center mb-3">
          <img
            [src]="getProductImage()"
            (error)="onImageError($event)"
            class="rounded me-3"
            style="width: 80px; height: 80px; object-fit: cover"
            [alt]="product.title || 'Product'"
          />
          <div>
            <h6 class="mb-1">{{ product.title || "Unknown Product" }}</h6>
            <p class="text-muted mb-1">
              Sold by: {{ product.userName || "Unknown Seller" }}
            </p>
            <p class="text-primary mb-0">
              {{
                product.price
                  ? (product.price | currency : "EGP" : "symbol" : "1.2-2")
                  : "0.00"
              }}
            </p>
          </div>
        </div>
        <hr />
        <div class="d-flex justify-content-between">
          <span>Subtotal</span>
          <span>{{
            product && product.price && orderRequest.quantity
              ? (product.price * orderRequest.quantity
                | currency : "EGP" : "symbol" : "1.2-2")
              : "0.00"
          }}</span>
        </div>
        <div class="d-flex justify-content-between mt-2">
          <span>Shipping Fee</span>
          <span>{{
            isSwapOrder
              ? SWAP_SHIPPING_FEE
              : (REGULAR_SHIPPING_FEE | currency : "EGP" : "symbol" : "1.2-2")
          }}</span>
        </div>
        <div class="d-flex justify-content-between mt-2">
          <strong>Total</strong>
          <strong class="text-primary">{{
            totalAmount | currency : "EGP" : "symbol" : "1.2-2"
          }}</strong>
        </div>
      </div>
    </div>
  </div>

  <!-- Empty Product State -->
  <div *ngIf="!isLoading && !product" class="text-center py-5">
    <div class="empty-state">
      <i class="bi bi-cart display-1 text-muted mb-3"></i>
      <h3>No product selected</h3>
      <p class="text-muted mb-4">
        Please select a product to proceed with checkout.
      </p>
      <a routerLink="/products" class="btn btn-primary">Shop Now</a>
    </div>
  </div>
</div>
